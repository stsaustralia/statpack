<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Spreadsheet → labelMappings (One Line per Metric)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: system-ui, monospace; margin: 20px; }
  h1 { font-size: 20px; margin: 0 0 12px; }
  textarea { width: 100%; min-height: 220px; font-family: monospace; font-size: 13px; }
  .btn { padding: 6px 12px; border: 1px solid #bbb; background: #f6f6f6; border-radius: 6px; cursor: pointer; }
  .btn.primary { background: #1f6feb; color: #fff; border-color: #1b5fd1; }
  .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; background: #fff; margin-top: 12px; }
  pre { background: #0f172a; color: #e5e7eb; padding: 12px; border-radius: 8px; overflow: auto; font-size: 12px; white-space: pre; }
</style>
</head>
<body>
<h1>Spreadsheet → <code>labelMappings</code></h1>

<div class="card">
  <h2>1) Paste your table (TSV/CSV)</h2>
  <textarea id="paste" placeholder="Paste from Numbers/Excel/Sheets. First row must contain headers (metric value/label pairs)."></textarea>
  <div style="margin-top:10px">
    <button class="btn primary" id="parseBtn">Parse & Generate</button>
    <button class="btn" id="clearBtn">Clear</button>
    <span id="info" style="font-size:12px;color:#555"></span>
  </div>
</div>

<div class="card" id="outCard" style="display:none">
  <div style="margin-bottom:10px;text-align:right">
    <button class="btn" id="copyBtn">Copy</button>
    <button class="btn" id="downloadBtn">Download .js</button>
  </div>
  <h2>2) Generated code</h2>
  <pre id="codeOut"></pre>
</div>

<script>
(function(){
  "use strict";
  const $ = s => document.querySelector(s);

  function detectDelimiter(text){
    const line = (text.split(/\r?\n/).find(l => l.trim().length) || "");
    const counts = { "\t": (line.match(/\t/g)||[]).length, ",": (line.match(/,/g)||[]).length, ";": (line.match(/;/g)||[]).length };
    return Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0];
  }

  function splitLine(line, delim){
    const out=[], d=delim; let cur="",inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){inQ=!inQ;cur+=ch;continue;}
      if(ch===d && !inQ){out.push(cur);cur="";continue;}
      cur+=ch;
    }
    out.push(cur);
    return out.map(s=>s.replace(/^"(.*)"$/,'$1').trim());
  }

  function parseTable(text, delim){
    const rows=text.replace(/\r/g,'').split("\n").filter(r=>r.trim().length);
    if(!rows.length)return{headers:[],data:[]};
    const headers=splitLine(rows[0],delim);
    const data=rows.slice(1).map(r=>splitLine(r,delim));
    return{headers,data};
  }

  function normMetric(h){
    return (h||"metric").toString()
      .replace(/\s+(value|label)$/i,'')
      .trim().toLowerCase()
      .replace(/\s+/g,'_')
      .replace(/[^\w]+/g,'');
  }

  function quoteSingle(str){
    return "'" + String(str).replace(/\\/g,"\\\\").replace(/'/g,"\\'") + "'";
  }

  function buildFormat(headers, data){
    const colCount=Math.max(0,...data.map(r=>r.length),headers.length);
    const metrics=[];
    for(let c=0;c<colCount;c+=2){
      const name=normMetric(headers[c]||`metric_${(c/2)+1}`);
      const map={};
      for(const row of data){
        const k=(row[c]??"").toString().trim();
        const v=(row[c+1]??"").toString().trim();
        if(!k||!v)continue;
        map[k]=v;
      }
      metrics.push({name,map});
    }
    const lines=["const labelMappings = {"]; 
    metrics.forEach((m,idx)=>{
      const parts=Object.entries(m.map).map(([k,v])=>`"${k}": ${quoteSingle(v)}`);
      lines.push(`  ${m.name}: {${parts.join(", ")}},`);
    });
    lines.push("};");
    return lines.join("\n");
  }

  $("#parseBtn").addEventListener("click",()=>{
    const raw=$("#paste").value;
    if(!raw.trim()){alert("Paste table first.");return;}
    const delim=detectDelimiter(raw);
    const {headers,data}=parseTable(raw,delim);
    if(!headers.length){alert("Missing header row.");return;}
    const code=buildFormat(headers,data);
    $("#codeOut").textContent=code;
    $("#outCard").style.display="";
    $("#info").textContent=`Rows: ${data.length} • Cols: ${headers.length} • Delimiter: ${delim==="\\t"?"tab":delim}`;
  });

  $("#clearBtn").addEventListener("click",()=>{$("#paste").value="";$("#outCard").style.display="none";$("#info").textContent="";});

  $("#copyBtn").addEventListener("click",async()=>{
    try{await navigator.clipboard.writeText($("#codeOut").textContent);alert("Copied.");}catch{alert("Copy failed.");}
  });

  $("#downloadBtn").addEventListener("click",()=>{
    const blob=new Blob([$("#codeOut").textContent],{type:"application/javascript"});
    const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="labelMappings.js";
    document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},0);
  });
})();
</script>
</body>
</html>