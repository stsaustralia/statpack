<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>statpack – Food Mode + Variations (r2130_food_variations)</title>
<style>
  :root{
    --bg:#f7f7f8;
    --fg:#0b0b0c;
    --muted:#666;
    --primary:#007aff;
    --card:#ffffff;
    --border:#e6e6ea;
    --green:#2ecc71;
    --gold:#f1c40f;
    --red:#e74c3c;
    --shadow: 0 6px 18px rgba(0,0,0,0.08);
    --radius: 14px;
    --match:#e0f0ff;
    --match-border:#69a8ff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:14px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif}
  h1{font-size:20px;margin:16px 0;color:var(--primary)}
  .banner{background:#eef6ff;border-bottom:1px solid #d6e8ff;padding:8px 16px;color:#08427a;font-size:12px}
  .wrap{max-width:1280px;margin:0 auto;padding:16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
  label{display:block;font-size:12px;color:#333;margin-bottom:6px}
  input[type="text"], input[type="number"], select{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}
  input[readonly]{background:#fafafa}
  .controls .cell{min-width:160px;flex:1}
  .controls .cell.small{min-width:120px;max-width:160px}
  .controls .cell.xs{min-width:100px;max-width:120px}
  .btn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px 12px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.04)}
  .btn.primary{background:var(--primary);color:#fff;border-color:#006ae6}
  .btn.ghost{background:#fff}
  .btn.red{background:var(--red);color:#fff;border-color:#c0392b}
  .btn.green{background:var(--green);color:#fff;border-color:#27ae60}
  .btn.gold{background:var(--gold);color:#000;border-color:#d4ac0d}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .metric{border:1px solid var(--border);border-radius:12px;padding:10px;min-width:220px;flex:1}
  .metric header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .metric header .name{font-weight:600}
  .metric .buttons{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .metric .buttons button{padding:6px 0;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
  .metric .buttons button.active{border-color:#444;font-weight:600;box-shadow:inset 0 0 0 2px #222}
  .metric .fmode{margin-left:6px;font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid var(--border);background:#fafafa;cursor:pointer}
  .note-groups h3{margin:0 0 8px 0;font-size:13px;color:#333}
  .note-group{margin-bottom:8px}
  .note-buttons{display:grid;grid-template-columns:repeat(10, 100px);gap:6px}
  .note-buttons button{height:32px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px}
  table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  th,td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:12px;vertical-align:top}
  th{background:#fafafa;text-align:left;font-weight:600;position:sticky;top:0;z-index:1}
  tr:last-child td{border-bottom:none}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .tag{display:inline-block;padding:2px 6px;border-radius:999px;background:#eef1f5;border:1px solid var(--border);font-size:11px;color:#333;margin:2px 4px 0 0}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px}
  .pill.pos{background:rgba(46,204,113,.12);border:1px solid rgba(46,204,113,.4);color:#1e8449}
  .pill.neg{background:rgba(231,76,60,.12);border:1px solid rgba(231,76,60,.4);color:#922b21}
  .shade-none{background:transparent}
  .shade-very-low{background:rgba(231,76,60,1.0);color:#fff}
  .shade-low{background:rgba(231,76,60,0.5);color:#fff}
  .shade-medium{background:rgba(241,196,15,0.8)}
  .shade-high{background:rgba(46,204,113,0.5)}
  .shade-very-high{background:rgba(46,204,113,1.0);color:#fff}
  .muted{color:#777}
  .right{text-align:right}
  .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35);z-index:50;padding:20px}
  .modal.open{display:grid}
  .modal .window{background:#fff;border-radius:16px;box-shadow:var(--shadow);max-width:1000px;width:100%;max-height:85vh;overflow:auto;padding:16px;border:1px solid var(--border)}
  .modal header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .modal h2{margin:0;font-size:16px}
  .kbd{font-size:11px;border:1px solid var(--border);padding:2px 6px;border-radius:8px;background:#fafafa}
  .file{display:inline-block}
  .spacer{flex:1}
  .hint{font-size:12px;color:#555}
  .warning{color:#8a2d1a}
  tr.match-row td{ background: var(--match); }
  tr.match-row td[data-col="Food"]{ box-shadow: inset 0 0 0 2px var(--match-border); }
  .filter-badges{ display:flex; flex-wrap:wrap; gap:6px; }
  .filter-badges .tag{ background:#e9f2ff; border-color:#c8ddff; }
</style>
</head>
<body>
  <div class="banner mono">
    Access policy: using only your provided files/instructions (no internet). Hypothetical, legally authorised research context acknowledged. Times: 24-hour; format YYYY/MM/DD HH:MM:SS; units metric.
  </div>
  <div class="wrap">
    <h1>statpack – Food Mode + Variations</h1>

    <div class="card controls">
      <div class="row">
        <div class="cell small">
          <label for="timestamp">Timestamp (auto)</label>
          <input id="timestamp" type="text" class="mono" readonly>
        </div>
        <div class="cell small">
          <label for="sinceMeal">Since Meal (min)</label>
          <input id="sinceMeal" type="text" class="mono" readonly>
        </div>
        <div class="cell small">
          <label for="elapsed">Elapsed (min)</label>
          <input id="elapsed" type="text" class="mono" readonly>
        </div>
        <div class="cell">
          <label for="food">Food</label>
          <input id="food" type="text" placeholder="e.g., chicken salad, rice bowl, pizza slice">
        </div>
        <div class="cell xs">
          <label for="qty">Qty (g)</label>
          <input id="qty" type="number" min="0" step="1" value="0">
        </div>
        <div class="cell small">
          <label for="method">Method</label>
          <select id="method">
            <option>Baked</option><option>Grilled</option><option>Fried</option><option>Steamed</option>
            <option>Roasted</option><option>Raw</option><option>Boiled</option><option>Sous-vide</option>
            <option>Microwaved</option><option>Toasted</option><option>Other</option>
          </select>
        </div>
        <div class="cell">
          <label for="category">Category</label>
          <select id="category">
            <option>Staples &amp; Mains</option><option>Proteins &amp; Dairy</option><option>Fruit &amp; Veg</option>
            <option>Grains &amp; Bakery</option><option>Drinks</option><option>Treats &amp; Sauces</option><option>Context</option><option>Other</option>
          </select>
        </div>
        <div class="cell small">
          <label>&nbsp;</label>
          <button id="btnAdd" class="btn primary">Add Entry</button>
        </div>
        <div class="cell small">
          <label>&nbsp;</label>
          <button id="btnMealStart" class="btn gold" title="Marks a new meal anchor to compute 'Since Meal'">Mark Meal Start</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="metric" data-metric-root="enjoy">
          <header><span class="name">Enjoy</span><span class="pill pos" id="enjoyLabel">None</span><button class="fmode" data-fmetric="enjoy">Filter: off</button></header>
          <div class="buttons" data-metric="enjoy"></div>
        </div>
        <div class="metric" data-metric-root="satiety">
          <header><span class="name">Satiety</span><span class="pill pos" id="satietyLabel">None</span><button class="fmode" data-fmetric="satiety">Filter: off</button></header>
          <div class="buttons" data-metric="satiety"></div>
        </div>
        <div class="metric" data-metric-root="energy">
          <header><span class="name">Energy</span><span class="pill pos" id="energyLabel">None</span><button class="fmode" data-fmetric="energy">Filter: off</button></header>
          <div class="buttons" data-metric="energy"></div>
        </div>
        <div class="metric" data-metric-root="craving">
          <header><span class="name">Craving</span><span class="pill pos" id="cravingLabel">None</span><button class="fmode" data-fmetric="craving">Filter: off</button></header>
          <div class="buttons" data-metric="craving"></div>
        </div>
        <div class="metric" data-metric-root="negatives">
          <header><span class="name">Negatives</span><span class="pill neg" id="negativesLabel">None</span><button class="fmode" data-fmetric="negatives">Filter: off</button></header>
          <div class="buttons" data-metric="negatives"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Variation Metrics</h3>
      <div class="row">
        <div class="metric" data-metric-root="spice">
          <header><span class="name">Spice</span><span class="pill pos" id="spiceLabel">None</span><button class="fmode" data-fmetric="spice">Filter: off</button></header>
          <div class="buttons" data-metric="spice"></div>
        </div>
        <div class="metric" data-metric-root="sweet">
          <header><span class="name">Sweet</span><span class="pill pos" id="sweetLabel">None</span><button class="fmode" data-fmetric="sweet">Filter: off</button></header>
          <div class="buttons" data-metric="sweet"></div>
        </div>
        <div class="metric" data-metric-root="salt">
          <header><span class="name">Salt</span><span class="pill pos" id="saltLabel">None</span><button class="fmode" data-fmetric="salt">Filter: off</button></header>
          <div class="buttons" data-metric="salt"></div>
        </div>
        <div class="metric" data-metric-root="crunch">
          <header><span class="name">Crunch</span><span class="pill pos" id="crunchLabel">None</span><button class="fmode" data-fmetric="crunch">Filter: off</button></header>
          <div class="buttons" data-metric="crunch"></div>
        </div>
        <div class="metric" data-metric-root="hydration">
          <header><span class="name">Hydration</span><span class="pill pos" id="hydrationLabel">None</span><button class="fmode" data-fmetric="hydration">Filter: off</button></header>
          <div class="buttons" data-metric="hydration"></div>
        </div>
      </div>
    </div>

    <div class="card" id="tagPanel">
      <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <h3 style="margin:0">Food Tags</h3>
        <label style="display:flex; align-items:center; gap:6px; font-size:12px;">
          <input type="checkbox" id="matchAny"> Match ANY tag (otherwise ALL)
        </label>
        <div class="spacer"></div>
        <button class="btn" id="btnSavePreset" title="Save selected tags as a preset">Save Preset</button>
        <input type="text" id="presetName" placeholder="Preset name" style="max-width:180px">
        <select id="presetSelect" style="max-width:200px"><option value="">Load preset…</option></select>
        <button class="btn" id="btnLoadPreset">Load</button>
        <button class="btn" id="btnClearTags">Clear</button>
      </div>
      <div id="tagsHost"></div>
    </div>

    <div class="card">
      <div class="row" style="align-items:center">
        <div class="cell">
          <label>Food contains (text)</label>
          <input id="filterText" type="text" placeholder="e.g., chicken, rice">
        </div>
        <div class="cell">
          <label>Category filter</label>
          <select id="filterCategory">
            <option value="">(any)</option>
            <option>Staples &amp; Mains</option><option>Proteins &amp; Dairy</option><option>Fruit &amp; Veg</option>
            <option>Grains &amp; Bakery</option><option>Drinks</option><option>Treats &amp; Sauces</option><option>Context</option><option>Other</option>
          </select>
        </div>
        <div class="cell small">
          <label>&nbsp;</label>
          <button class="btn" id="btnApplyFilters">Highlight Matches</button>
        </div>
        <div class="cell small">
          <label>&nbsp;</label>
          <button class="btn" id="btnToggleHide">Hide Non-matches: Off</button>
        </div>
        <div class="cell small">
          <label>&nbsp;</label>
          <button class="btn red" id="btnClearFilters">Clear Filters</button>
        </div>
      </div>
      <div class="filter-badges" id="activeFilters" style="margin-top:8px"></div>
      <div class="hint" style="margin-top:6px">
        Tip: Toggle <span class="kbd">Filter</span> on a metric, then click its numbers to set thresholds (positive metrics use ≥, Negatives uses ≤). Selected tags are also used as filters.
      </div>
    </div>

    <div class="card note-groups" id="noteGroups"></div>

    <div class="card">
      <div class="toolbar">
        <button class="btn" id="btnRated">Rated Popup</button>
        <button class="btn" id="btnAllRated">AllRated Popup</button>
        <button class="btn" id="btn5m">Summary 5 m</button>
        <button class="btn" id="btn15m">Summary 15 m</button>
        <button class="btn" id="btn60m">Summary 60 m</button>
        <button class="btn" id="btnSliding">Sliding Average</button>
        <span class="spacer"></span>
        <button class="btn" id="btnAutoSummary">Auto Summary: Off</button>
        <button class="btn" id="btnExport">Export CSV</button>
        <label class="file btn ghost">
          Import CSV <input id="fileImport" type="file" accept=".csv" style="display:none">
        </label>
      </div>
    </div>

    <div class="card">
      <table id="logTable">
        <thead>
          <tr>
            <th>Timestamp</th><th>Since Meal</th><th>Elapsed</th><th>Food</th><th>Qty (g)</th><th>Method</th><th>Category</th>
            <th>Enjoy</th><th>Satiety</th><th>Energy</th><th>Craving</th><th>Negatives</th>
            <th>Spice</th><th>Sweet</th><th>Salt</th><th>Crunch</th><th>Hydration</th>
            <th>Score</th><th>Tags</th><th>Custom Notes</th><th>Notes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="hint" style="margin-top:8px">Score = (Enjoy+Satiety+Energy+Craving) − Negatives.</div>
    </div>

    <div class="modal" id="modalRated">
      <div class="window">
        <header><h2>Rated Popup (current selections)</h2><button class="btn" data-close="#modalRated">Close</button></header>
        <div id="ratedContent"></div>
      </div>
    </div>

    <div class="modal" id="modalAllRated">
      <div class="window">
        <header><h2>AllRated Popup (per-row classifications)</h2><button class="btn" data-close="#modalAllRated">Close</button></header>
        <div id="allRatedContent"></div>
      </div>
    </div>

    <div class="modal" id="modalSummary">
      <div class="window">
        <header><h2 id="summaryTitle">Summary</h2><button class="btn" data-close="#modalSummary">Close</button></header>
        <div id="summaryContent"></div>
      </div>
    </div>

  </div>

<script>
const CONFIG = {
  metrics: ["enjoy","satiety","energy","craving","negatives"],
  variationMetrics: ["spice","sweet","salt","crunch","hydration"],
  metricLabels: {
    enjoy:["None","Bland","OK","Tasty","Very Tasty","Delicious","Exceptional"],
    satiety:["None","Slight","Light","Moderate","Full","Very full","Overfull"],
    energy:["None","Subtle","Mild","Noticeable","Strong","Very strong","Wired"],
    craving:["None","Slight","Some","Good","Strong","Very strong","Completely satisfied"],
    negatives:["None","Trace","Mild","Moderate","Marked","Severe","Extreme"],
    spice:["None","Hint","Mild","Medium","Hot","Very hot","Extreme"],
    sweet:["None","Hint","Mild","Medium","Sweet","Very sweet","Dessert"],
    salt:["None","Hint","Mild","Medium","Salty","Very salty","Briny"],
    crunch:["None","Soft","Tender","Some","Crunchy","Very crunchy","Ultra"],
    hydration:["None","Drying","Slightly hydrating","Moderate","Hydrating","Very hydrating","Liquid"]
  },
  thresholds:{
    none:v=>v===0, veryLow:v=>v>0&&v<=1, low:v=>v>1&&v<=2, medium:v=>v>2&&v<4, high:v=>v>=4&&v<5, veryHigh:v=>v>=5
  },
  noteGroups:[
    {name:"Staples & Mains", items:["rice","pasta","noodles","pizza","burger","wrap","salad","soup","curry","stew"]},
    {name:"Proteins & Dairy", items:["chicken","beef","lamb","pork","tofu","tempeh","eggs","fish","yoghurt","cheese"]},
    {name:"Fruit & Veg", items:["apple","banana","berries","citrus","greens","crucifers","tomato","avocado","potato","pumpkin"]},
    {name:"Grains & Bakery", items:["wholegrain","sourdough","rye","oats","cereal","pastry","cake","biscuits","muffin","bagel"]},
    {name:"Preparation/Method", items:["baked","grilled","fried","steamed","roasted","raw","spicy","sweet","savoury","salty"]},
    {name:"Drinks", items:["water","coffee","tea","juice","milk","smoothie","soft drink","energy drink","alcohol","electrolyte"]},
    {name:"Treats & Sauces", items:["chocolate","ice-cream","lollies","jam","honey","mayo","aioli","ketchup","mustard","chilli"]},
    {name:"Context", items:["alone","social","work","post-exercise","late","morning","takeaway","home-cooked","restaurant","rushed"]}
  ],
  tags:[
    {group:"Dietary", items:["vegan","vegetarian","gluten-free","lactose-free","low-FODMAP","keto","halal","kosher"]},
    {group:"Flavour", items:["sweet","salty","umami","bitter","sour","spicy"]},
    {group:"Texture", items:["creamy","crunchy","chewy","soft"]},
    {group:"Time", items:["breakfast","lunch","dinner","snack","pre-workout","post-workout"]},
    {group:"Origin", items:["asian","mediterranean","indian","mexican","middle-eastern","european"]}
  ],
  autoSummarySeconds:60
};

let STATE = {
  selections:{enjoy:0,satiety:0,energy:0,craving:0,negatives:0},
  variations:{spice:0,sweet:0,salt:0,crunch:0,hydration:0},
  notes:[], selectedTags:new Set(), customNotes:"", rows:[], sessionStart:Date.now(), lastMealStartTs:null, autoTimer:null,
  filterMode:{enjoy:false,satiety:false,energy:false,craving:false,negatives:false,spice:false,sweet:false,salt:false,crunch:false,hydration:false},
  filters:{min:{},max:{},text:"",category:"",any:false,hide:false,tags:new Set()}, presets:{}
};

function pad2(n){return n<10?"0"+n:""+n;}
function formatTS(d){const Y=d.getFullYear(),M=pad2(d.getMonth()+1),D=pad2(d.getDate()),h=pad2(d.getHours()),m=pad2(d.getMinutes()),s=pad2(d.getSeconds());return `${Y}/${M}/${D} ${h}:${m}:${s}`;}
function minutesBetween(a,b){return Math.round((a-b)/60000);}
function el(s,r=document){return r.querySelector(s);} function els(s,r=document){return Array.from(r.querySelectorAll(s));}
function esc(s){return (s??"").toString().replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}

function computeScore(r){return (r.enjoy||0)+(r.satiety||0)+(r.energy||0)+(r.craving||0) - (r.negatives||0);}
function classifyShade(v){const T=CONFIG.thresholds;return T.none(v)?"shade-none":T.veryLow(v)?"shade-very-low":T.low(v)?"shade-low":T.medium(v)?"shade-medium":T.high(v)?"shade-high":T.veryHigh(v)?"shade-very-high":"shade-none";}
function bandName(v){const T=CONFIG.thresholds;return T.none(v)?"none":T.veryLow(v)?"very low":T.low(v)?"low":T.medium(v)?"medium":T.high(v)?"high":T.veryHigh(v)?"very high":"none";}
function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}

function initMetricButtons(){
  const all=[...CONFIG.metrics,...CONFIG.variationMetrics];
  all.forEach(metric=>{
    const container=document.querySelector(`.buttons[data-metric="${metric}"]`); if(!container) return;
    for(let v=6; v>=0; v--){
      const btn=document.createElement("button"); btn.textContent=v; btn.title=CONFIG.metricLabels[metric][v];
      btn.addEventListener("click",()=>{
        if(STATE.filterMode[metric]){
          if(metric==="negatives"){ STATE.filters.max[metric]=v; } else { STATE.filters.min[metric]=v; }
          updateActiveFiltersBadges(); applyRowMatching();
        }else{
          if(CONFIG.metrics.includes(metric)){ STATE.selections[metric]=v; } else { STATE.variations[metric]=v; }
          updateMetricLabels(); els("button",container).forEach(b=>b.classList.toggle("active",b===btn));
        }
      });
      container.appendChild(btn);
    }
  });
}
function toggleFilterMode(metric){
  STATE.filterMode[metric]=!STATE.filterMode[metric];
  const btn=document.querySelector(`.fmode[data-fmetric="${metric}"]`);
  if(btn){ btn.textContent="Filter: "+(STATE.filterMode[metric]?"on":"off"); }
}
function updateMetricLabels(){
  el("#enjoyLabel").textContent=CONFIG.metricLabels.enjoy[STATE.selections.enjoy];
  el("#satietyLabel").textContent=CONFIG.metricLabels.satiety[STATE.selections.satiety];
  el("#energyLabel").textContent=CONFIG.metricLabels.energy[STATE.selections.energy];
  el("#cravingLabel").textContent=CONFIG.metricLabels.craving[STATE.selections.craving];
  el("#negativesLabel").textContent=CONFIG.metricLabels.negatives[STATE.selections.negatives];
  el("#spiceLabel").textContent=CONFIG.metricLabels.spice[STATE.variations.spice];
  el("#sweetLabel").textContent=CONFIG.metricLabels.sweet[STATE.variations.sweet];
  el("#saltLabel").textContent=CONFIG.metricLabels.salt[STATE.variations.salt];
  el("#crunchLabel").textContent=CONFIG.metricLabels.crunch[STATE.variations.crunch];
  el("#hydrationLabel").textContent=CONFIG.metricLabels.hydration[STATE.variations.hydration];
}
function initNoteGroups(){
  const host=el("#noteGroups"); host.innerHTML="";
  CONFIG.noteGroups.forEach(g=>{
    const box=document.createElement("div"); box.className="note-group";
    const h=document.createElement("h3"); h.textContent=g.name; box.appendChild(h);
    const grid=document.createElement("div"); grid.className="note-buttons";
    g.items.forEach(tok=>{ const b=document.createElement("button"); b.textContent=tok; b.addEventListener("click",()=>{ STATE.notes.push(tok); }); grid.appendChild(b); });
    box.appendChild(grid); host.appendChild(box);
  });
}
function initTags(){
  const host=el("#tagsHost"); host.innerHTML="";
  CONFIG.tags.forEach(group=>{
    const card=document.createElement("div"); card.className="card"; card.style.margin="8px 0";
    const h=document.createElement("h3"); h.textContent=group.group; h.style.margin="0 0 6px 0"; card.appendChild(h);
    const grid=document.createElement("div"); grid.className="note-buttons";
    group.items.forEach(tag=>{
      const b=document.createElement("button"); b.textContent=tag; b.title="Toggle tag";
      b.addEventListener("click",()=>{
        if(STATE.selectedTags.has(tag)){ STATE.selectedTags.delete(tag); b.classList.remove("active"); }
        else { STATE.selectedTags.add(tag); b.classList.add("active"); }
        updateActiveFiltersBadges();
      });
      grid.appendChild(b);
    });
    card.appendChild(grid); host.appendChild(card);
  });
}

function addEntry(){
  const now=new Date(); const ts=formatTS(now);
  const sinceMeal=(STATE.lastMealStartTs ? minutesBetween(now.getTime(), STATE.lastMealStartTs) : 0);
  const elapsed=minutesBetween(now.getTime(), STATE.sessionStart);
  const row={
    timestamp:ts, sinceMeal, elapsed, food:el("#food").value.trim(), qty:Number(el("#qty").value)||0,
    method:el("#method").value, category:el("#category").value,
    enjoy:STATE.selections.enjoy, satiety:STATE.selections.satiety, energy:STATE.selections.energy,
    craving:STATE.selections.craving, negatives:STATE.selections.negatives,
    spice:STATE.variations.spice, sweet:STATE.variations.sweet, salt:STATE.variations.salt, crunch:STATE.variations.crunch, hydration:STATE.variations.hydration,
    score:0, tags:Array.from(STATE.selectedTags), customNotes:"", notes:[...STATE.notes]
  };
  row.score=computeScore(row);
  STATE.rows.push(row); STATE.notes=[];
  renderTable(); refreshTimestamps(); applyRowMatching();
}
function renderTable(){
  const tb=el("#logTable tbody"); tb.innerHTML="";
  STATE.rows.forEach((r,idx)=>{
    const tr=document.createElement("tr"); tr.dataset.idx=idx;
    const add=(text,col)=>{ const td=document.createElement("td"); td.textContent=text; td.setAttribute("data-col",col); tr.appendChild(td); };
    add(r.timestamp,"Timestamp"); add(r.sinceMeal,"Since Meal"); add(r.elapsed,"Elapsed"); add(r.food,"Food"); add(r.qty,"Qty (g)"); add(r.method,"Method");
    const tdCat=document.createElement("td"); tdCat.innerHTML=`<span class="tag">${r.category}</span>`; tdCat.setAttribute("data-col","Category"); tr.appendChild(tdCat);
    ["enjoy","satiety","energy","craving","negatives","spice","sweet","salt","crunch","hydration"].forEach(m=>{
      const td=document.createElement("td"); const v=r[m]??0; td.textContent=v; td.title=CONFIG.metricLabels[m][v]; td.className=classifyShade(v); td.setAttribute("data-col",cap(m)); tr.appendChild(td);
    });
    add(r.score,"Score");
    const tdTags=document.createElement("td"); tdTags.setAttribute("data-col","Tags"); (r.tags||[]).forEach(t=>{ const s=document.createElement("span"); s.className="tag"; s.textContent=t; tdTags.appendChild(s); }); tr.appendChild(tdTags);
    add(r.customNotes||"","Custom Notes"); add((r.notes||[]).join(", "),"Notes");
    tb.appendChild(tr);
  });
}

function updateActiveFiltersBadges(){
  const host=el("#activeFilters"); host.innerHTML="";
  const {min,max,text,category,any}=STATE.filters;
  Object.entries(min).forEach(([m,v])=>{ const s=document.createElement("span"); s.className="tag"; s.textContent=`${cap(m)} ≥ ${v}`; host.appendChild(s); });
  Object.entries(max).forEach(([m,v])=>{ const s=document.createElement("span"); s.className="tag"; s.textContent=`${cap(m)} ≤ ${v}`; host.appendChild(s); });
  if(text){ const s=document.createElement("span"); s.className="tag"; s.textContent=`Food contains “${text}”`; host.appendChild(s); }
  if(category){ const s=document.createElement("span"); s.className="tag"; s.textContent=`Category = ${category}`; host.appendChild(s); }
  const tagList=Array.from(STATE.selectedTags);
  if(tagList.length){ const s=document.createElement("span"); s.className="tag"; s.textContent=`Tags: ${tagList.join(any?" OR ":" AND ")}`; host.appendChild(s); }
}
function rowMatches(r){
  for(const [m,v] of Object.entries(STATE.filters.min)){ if((r[m]??0)<v) return false; }
  for(const [m,v] of Object.entries(STATE.filters.max)){ if((r[m]??0)>v) return false; }
  const t=STATE.filters.text?.trim().toLowerCase(); if(t && !(r.food||"").toLowerCase().includes(t)) return false;
  if(STATE.filters.category && (r.category||"")!==STATE.filters.category) return false;
  const need=Array.from(STATE.selectedTags);
  if(need.length){
    const set=new Set(r.tags||[]);
    if(STATE.filters.any){ if(!need.some(tag=>set.has(tag))) return false; }
    else{ if(!need.every(tag=>set.has(tag))) return false; }
  }
  return true;
}
function applyRowMatching(){
  const tb=el("#logTable tbody"); Array.from(tb.children).forEach(tr=>tr.classList.remove("match-row"));
  STATE.rows.forEach((r,idx)=>{
    const tr=tb.querySelector(`tr[data-idx="${idx}"]`); if(!tr) return;
    const match=rowMatches(r); if(match) tr.classList.add("match-row");
    tr.style.display=(STATE.filters.hide && !match)?"none":"";
  });
}

function openRatedPopup(){
  const cur={...STATE.selections,...STATE.variations};
  const rows=[`<table><thead><tr><th>Metric</th><th>Value</th><th>Label</th><th>Band</th></tr></thead><tbody>`];
  const all=[...CONFIG.metrics,...CONFIG.variationMetrics];
  for(const m of all){ const v=cur[m]||0; const label=CONFIG.metricLabels[m][v]; const band=bandName(v); rows.push(`<tr><td>${cap(m)}</td><td class="right">${v}</td><td>${label}</td><td>${band}</td></tr>`); }
  rows.push("</tbody></table>"); el("#ratedContent").innerHTML=rows.join(""); openModal("#modalRated");
}
function openAllRatedPopup(){
  const rows=[`<table><thead><tr>
  <th>Timestamp</th><th>Food</th><th>Qty</th><th>Method</th>
  <th>Enjoy</th><th>Satiety</th><th>Energy</th><th>Craving</th><th>Negatives</th>
  <th>Spice</th><th>Sweet</th><th>Salt</th><th>Crunch</th><th>Hydration</th>
  <th>Score</th><th>Tags</th></tr></thead><tbody>`];
  STATE.rows.forEach(r=>{
    rows.push(`<tr>
      <td class="mono">${r.timestamp}</td><td>${esc(r.food)}</td><td class="right">${r.qty}</td><td>${esc(r.method)}</td>
      ${metricCell(r.enjoy,"enjoy")}${metricCell(r.satiety,"satiety")}${metricCell(r.energy,"energy")}${metricCell(r.craving,"craving")}${metricCell(r.negatives,"negatives")}
      ${metricCell(r.spice,"spice")}${metricCell(r.sweet,"sweet")}${metricCell(r.salt,"salt")}${metricCell(r.crunch,"crunch")}${metricCell(r.hydration,"hydration")}
      <td class="right">${r.score}</td><td>${(r.tags||[]).map(t=>`<span class="tag">${esc(t)}</span>`).join("")}</td></tr>`);
  });
  rows.push("</tbody></table>"); el("#allRatedContent").innerHTML=rows.join(""); openModal("#modalAllRated");
}
function metricCell(v,m){const shade=classifyShade(v); const label=CONFIG.metricLabels[m][v]??""; return `<td class="${shade} right" title="${esc(label)}">${v}</td>`;}

function openSummaryWindow(kind){
  const titleMap={"5m":"Summary 5 m","15m":"Summary 15 m","60m":"Summary 60 m","sliding":"Sliding Average"};
  el("#summaryTitle").textContent=titleMap[kind]||"Summary";
  const now=Date.now(); let windowMs=0;
  if(kind==="5m") windowMs=5*60000; else if(kind==="15m") windowMs=15*60000; else if(kind==="60m") windowMs=60*60000;
  const rows=(windowMs>0)?STATE.rows.filter(r=> (now-parseTS(r.timestamp))<=windowMs ) : STATE.rows.slice(-Math.min(STATE.rows.length,10));
  const stats=aggregateStats(rows); el("#summaryContent").innerHTML=renderStatsTable(stats, rows.length); openModal("#modalSummary");
}
function parseTS(str){const [d,t]=str.split(" "); const [Y,M,D]=d.split("/").map(Number); const [h,m,s]=t.split(":").map(Number); return new Date(Y,M-1,D,h,m,s).getTime();}
function aggregateStats(rows){
  const acc={count:rows.length}; const all=[...CONFIG.metrics,...CONFIG.variationMetrics];
  all.forEach(m=>{ acc[m]={sum:0,avg:0,max:0,min:6}; });
  rows.forEach(r=>{ all.forEach(m=>{ const v=Number(r[m]||0); acc[m].sum+=v; acc[m].max=Math.max(acc[m].max,v); acc[m].min=Math.min(acc[m].min,v); }); });
  all.forEach(m=>{ acc[m].avg = rows.length ? (acc[m].sum/rows.length) : 0; });
  const scores=rows.map(r=>r.score||0);
  acc.score={ avg: rows.length ? (scores.reduce((a,b)=>a+b,0)/rows.length) : 0, max: rows.length ? Math.max(...scores) : 0, min: rows.length ? Math.min(...scores) : 0 };
  return acc;
}
function renderStatsTable(stats,n){
  const fmt=x=>(Math.round(x*100)/100).toFixed(2);
  const all=[...CONFIG.metrics,...CONFIG.variationMetrics];
  const head=`<div class="hint">n=${n}</div><table><thead><tr><th>Metric</th><th>Avg</th><th>Min</th><th>Max</th></tr></thead><tbody>`;
  const rows=all.map(m=>`<tr><td>${cap(m)}</td><td class="right">${fmt(stats[m].avg)}</td><td class="right">${stats[m].min}</td><td class="right">${stats[m].max}</td></tr>`).join("");
  const tail=`</tbody></table><div style="margin-top:8px"><span class="tag">Score avg: ${fmt(stats.score.avg)}</span><span class="tag">Score min: ${stats.score.min}</span><span class="tag">Score max: ${stats.score.max}</span></div>`;
  return head+rows+tail;
}

function toggleAutoSummary(){
  const btn=el("#btnAutoSummary");
  if(STATE.autoTimer){ clearInterval(STATE.autoTimer); STATE.autoTimer=null; btn.textContent="Auto Summary: Off"; }
  else{ STATE.autoTimer=setInterval(()=>{ const cycle=["5m","15m","60m","sliding"]; const idx=Math.floor((Date.now()/1000)/CONFIG.autoSummarySeconds)%cycle.length; openSummaryWindow(cycle[idx]); }, CONFIG.autoSummarySeconds*1000); btn.textContent="Auto Summary: On"; }
}

function exportCSV(){
  const headers=["Timestamp","Since Meal","Elapsed","Info","Food","Qty (g)","Method",
    "Enjoy Sum","Enjoy Label","Satiety Sum","Satiety Label","Energy Sum","Energy Label",
    "Craving Sum","Craving Label","Negatives Sum","Negatives Label","Spice","Sweet","Salt","Crunch","Hydration",
    "Score","Tags","Custom Notes","Notes","Category"];
  const lines=[headers.join(",")];
  STATE.rows.forEach(r=>{
    const line=[r.timestamp,r.sinceMeal,r.elapsed,"",escCSV(r.food),r.qty,r.method,
      r.enjoy,CONFIG.metricLabels.enjoy[r.enjoy]||"", r.satiety,CONFIG.metricLabels.satiety[r.satiety]||"",
      r.energy,CONFIG.metricLabels.energy[r.energy]||"", r.craving,CONFIG.metricLabels.craving[r.craving]||"",
      r.negatives,CONFIG.metricLabels.negatives[r.negatives]||"", r.spice,r.sweet,r.salt,r.crunch,r.hydration,
      r.score,escCSV((r.tags||[]).join("; ")),escCSV(r.customNotes||""),escCSV((r.notes||[]).join("; ")),r.category];
    lines.push(line.join(","));
  });
  const blob=new Blob([lines.join("\n")],{type:"text/csv;charset=utf-8"});
  const a=document.createElement("a"); const ts=new Date(); const fname=`food_variations_${ts.getFullYear()}${pad2(ts.getMonth()+1)}${pad2(ts.getDate())}_${pad2(ts.getHours())}${pad2(ts.getMinutes())}${pad2(ts.getSeconds())}.csv`;
  a.href=URL.createObjectURL(blob); a.download=fname; a.click(); URL.revokeObjectURL(a.href);
}
function escCSV(s){const str=(s??"").toString(); return /[",\n]/.test(str)?'"'+str.replace(/"/g,'""')+'"':str;}
function importCSV(file){
  const reader=new FileReader();
  reader.onload=()=>{
    const text=reader.result; const rows=parseCSV(text); const hdr=rows.shift()||[];
    const idx=(name,aliases=[])=>{ const i=hdr.indexOf(name); if(i>=0) return i; for(const a of aliases){ const j=hdr.indexOf(a); if(j>=0) return j; } return -1; };
    const col={Timestamp:idx("Timestamp"), SinceMeal:idx("Since Meal",["Since Dose","Since meal"]), Elapsed:idx("Elapsed"), Food:idx("Food",["Drug"]),
      Qty:idx("Qty (g)",["Qty"]), Method:idx("Method",["ROA"]), Enjoy:idx("Enjoy Sum",["Enjoy","Rush Sum"]), Satiety:idx("Satiety Sum",["Satiety","Mood Sum"]),
      Energy:idx("Energy Sum",["Energy"]), Craving:idx("Craving Sum",["Craving","Social Sum"]), Negatives:idx("Negatives Sum",["Negatives","Anxiety Sum"]),
      Spice:idx("Spice"), Sweet:idx("Sweet"), Salt:idx("Salt"), Crunch:idx("Crunch"), Hydration:idx("Hydration"),
      Score:idx("Score"), Tags:idx("Tags"), Category:idx("Category")};
    rows.forEach(r=>{
      if(!r.length) return;
      const row={ timestamp:r[col.Timestamp]||"", sinceMeal:toNum(r[col.SinceMeal]), elapsed:toNum(r[col.Elapsed]), food:r[col.Food]||"",
        qty:toNum(r[col.Qty]), method:r[col.Method]||"", category:r[col.Category]||"",
        enjoy:toNum(r[col.Enjoy]), satiety:toNum(r[col.Satiety]), energy:toNum(r[col.Energy]), craving:toNum(r[col.Craving]), negatives:toNum(r[col.Negatives]),
        spice:toNum(r[col.Spice]), sweet:toNum(r[col.Sweet]), salt:toNum(r[col.Salt]), crunch:toNum(r[col.Crunch]), hydration:toNum(r[col.Hydration]),
        score:toNum(r[col.Score]), tags:(r[col.Tags]||"").split(/;\s*/).filter(Boolean), customNotes:"", notes:[] };
      if(!isFinite(row.score)) row.score=computeScore(row);
      STATE.rows.push(row);
    });
    renderTable(); refreshTimestamps(); applyRowMatching(); alert("Import complete. Rows added: "+rows.length);
  };
  reader.readAsText(file);
}
function parseCSV(text){
  const rows=[]; let i=0,cur="",inQ=false,row=[];
  while(i<text.length){
    const ch=text[i++];
    if(inQ){
      if(ch==='\"'){ if(text[i]==='\"'){cur+='\"';i++;} else {inQ=false;} }
      else cur+=ch;
    }else{
      if(ch==='\"') inQ=true;
      else if(ch===','){row.push(cur);cur="";}
      else if(ch==='\n'){row.push(cur);rows.push(row);row=[];cur="";}
      else if(ch==='\r'){}
      else cur+=ch;
    }
  }
  if(cur.length>0||row.length>0){row.push(cur);rows.push(row);}
  return rows;
}
function toNum(x){const n=Number((x??"").toString().trim()); return isFinite(n)?n:0;}

function refreshTimestamps(){
  const now=new Date(); el("#timestamp").value=formatTS(now);
  const elapsed=minutesBetween(now.getTime(), STATE.sessionStart); el("#elapsed").value=elapsed;
  el("#sinceMeal").value = STATE.lastMealStartTs ? minutesBetween(now.getTime(), STATE.lastMealStartTs) : 0;
}

function openModal(sel){const m=el(sel); if(m) m.classList.add("open");}
function closeModal(sel){const m=el(sel); if(m) m.classList.remove("open");}

function savePreset(){
  const name=el("#presetName").value.trim(); if(!name){alert("Enter a preset name.");return;}
  STATE.presets[name]=Array.from(STATE.selectedTags);
  const sel=el("#presetSelect"); let exists=false;
  Array.from(sel.options).forEach(o=>{ if(o.value===name) exists=true; });
  if(!exists){ const opt=document.createElement("option"); opt.value=opt.textContent=name; sel.appendChild(opt); }
  localStorage.setItem("foodTagPresets", JSON.stringify(STATE.presets)); alert("Preset saved.");
}
function loadPreset(){
  const name=el("#presetSelect").value; if(!name) return;
  const tags=STATE.presets[name]||[]; STATE.selectedTags=new Set(tags);
  els("#tagsHost .note-buttons button").forEach(b=>{ const tag=b.textContent; if(STATE.selectedTags.has(tag)) b.classList.add("active"); else b.classList.remove("active"); });
  updateActiveFiltersBadges();
}

window.addEventListener("DOMContentLoaded", ()=>{
  initMetricButtons(); updateMetricLabels(); initNoteGroups(); initTags(); refreshTimestamps(); setInterval(refreshTimestamps,1000);
  try{ STATE.presets=JSON.parse(localStorage.getItem("foodTagPresets")||"{}"); const sel=el("#presetSelect"); Object.keys(STATE.presets).forEach(n=>{const o=document.createElement("option");o.value=o.textContent=n; sel.appendChild(o);}); }catch(e){}
  els(".fmode").forEach(btn=>btn.addEventListener("click",()=>toggleFilterMode(btn.getAttribute("data-fmetric"))));
  el("#btnAdd").addEventListener("click", addEntry);
  el("#btnMealStart").addEventListener("click", ()=>{ STATE.lastMealStartTs=Date.now(); refreshTimestamps(); });
  el("#btnRated").addEventListener("click", openRatedPopup);
  el("#btnAllRated").addEventListener("click", openAllRatedPopup);
  el("#btn5m").addEventListener("click", ()=>openSummaryWindow("5m"));
  el("#btn15m").addEventListener("click", ()=>openSummaryWindow("15m"));
  el("#btn60m").addEventListener("click", ()=>openSummaryWindow("60m"));
  el("#btnSliding").addEventListener("click", ()=>openSummaryWindow("sliding"));
  el("#btnAutoSummary").addEventListener("click", toggleAutoSummary);
  el("#btnExport").addEventListener("click", exportCSV);
  el("#fileImport").addEventListener("change",(e)=>{ if(e.target.files&&e.target.files[0]) importCSV(e.target.files[0]); e.target.value=""; });
  el("#btnApplyFilters").addEventListener("click", ()=>{ STATE.filters.text=el("#filterText").value; STATE.filters.category=el("#filterCategory").value; STATE.filters.any=el("#matchAny").checked; updateActiveFiltersBadges(); applyRowMatching(); });
  el("#btnToggleHide").addEventListener("click",(ev)=>{ STATE.filters.hide=!STATE.filters.hide; ev.target.textContent=`Hide Non-matches: ${STATE.filters.hide?"On":"Off"}`; applyRowMatching(); });
  el("#btnClearFilters").addEventListener("click", ()=>{ STATE.filters={min:{},max:{},text:"",category:"",any:false,hide:STATE.filters.hide,tags:new Set()}; STATE.selectedTags.clear(); els("#tagsHost .note-buttons button").forEach(b=>b.classList.remove("active")); el("#filterText").value=""; el("#filterCategory").value=""; el("#matchAny").checked=false; updateActiveFiltersBadges(); applyRowMatching(); });
  el("#btnSavePreset").addEventListener("click", savePreset);
  el("#btnLoadPreset").addEventListener("click", loadPreset);
  els("[data-close]").forEach(btn=>btn.addEventListener("click",()=>closeModal(btn.getAttribute("data-close"))));
  els(".modal").forEach(m=>m.addEventListener("click",(e)=>{ if(e.target.classList.contains("modal")) m.classList.remove("open"); }));
});
</script>
</body>
</html>
